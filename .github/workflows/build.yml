name: Test - Build and deploy
on:
  workflow_dispatch:

env:
  LOCATION: "westeurope"  
  RG_NAME: "cnawebappui-rg"
  ACR_NAME: "cnawebappuiacr"
  ACR_SKU: "Standard"
  IMAGE_NAME: "woodgrove"
  APP_PLAN_NAME: "cnawebappuiacr-plan"
  APP_PLAN_SKU: "P1v2"
  SITE_NAME: "woodgrove007"  
  ACR_REGISTRY_NAME: "cnawebappuiacr.azurecr.io"
  ACR_REGISTRY_USER: "cnawebappuiacr"
  ACR_REGISTRY_PWD: "=bGjRHKm/xp+TL3AITAey35GHOFuYnOK"
  ACR_REGISTRY_IMAGE_NAME: "cnawebappuiacr.azurecr.io/woodgrove"
  IMAGE_VERSION: "1.0.0"
  
  DOTNET_VERSION: 3.1.x
  SRC_PATH: ./src 


jobs:                                     
  build-Test-Push-Image:
    runs-on: ubuntu-20.04

    steps:
    - name: "Checkout the code"
      uses: actions/checkout@v2

    - name: Login to Azure
      uses: Azure/login@v1
      with:        
          creds: ${{secrets.AZURE_CREDENTIALS}}

    - name: Deploy infra WebApp
      run: |
        az deployment sub create \
          --location ${{ env.LOCATION}} \
          --template-file ./Bicep/mainWebApp.bicep \
          --parameters 'RgSiteName=${{ env.RG_NAME }}' 'appPlanName=${{ env.APP_PLAN_NAME }}' 'skuPlan=${{ env.APP_PLAN_SKU }}' 'siteName=${{ env.SITE_NAME }}' 'ACRRegistryName=${{ env.ACR_REGISTRY_NAME }}' 'ACRRegistryUser=${{ env.ACR_REGISTRY_USER }}' 'ACRRegistryPWD=${{ env.ACR_REGISTRY_PWD }}' 'ImageName=${{ env.ACR_REGISTRY_IMAGE_NAME }}' 'ImageVersion=${{ env.IMAGE_VERSION }}'
           

